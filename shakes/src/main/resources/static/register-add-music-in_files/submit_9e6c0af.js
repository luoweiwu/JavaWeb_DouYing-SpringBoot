define("web:page/musician/apply/submitMusic/submit",function(require,exports,module){function _interopRequireDefault(t){return t&&t.__esModule?t:{"default":t}}var _file=_interopRequireDefault(require("web:page/musician/apply/utils/file")),_form=_interopRequireDefault(require("web:page/musician/apply/utils/form")),_toast=_interopRequireDefault(require("web:page/musician/apply/utils/toast")),_dropkick=_interopRequireDefault(require("web:page/musician/apply/utils/dropkick")),_xss=_interopRequireDefault(require("web:page/musician/apply/utils/xss"));"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t){"use strict";if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(t),e=1;e<arguments.length;e++){var n=arguments[e];if(null!=n)for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(i[a]=n[a])}return i},writable:!0,configurable:!0}),$(function(){function getLyricType(t){switch(t){case"lrc":return 2;case"trc":return 1;default:return 0}}function verifyFlip(){var t={disabled:!0,style:"color: #ccc"},i={disabled:!1,style:"color: #000"};$("#pagePre").attr(musicCtrl.canFlip().pre?i:t),$("#pageNxt").attr(musicCtrl.canFlip().nxt?i:t)}function progress(t){var i=$(t);return function(t){if(t.lengthComputable){var e=t.loaded/t.total;e=parseInt(100*e)>=100?99:parseInt(100*e),i.val("".concat(e,"%"))}}}var musicCtrl=function(){function isFunc(t){return"function"==typeof t}function init(t){return $container=$(t),requestMusicList(0,limit).then(function(t){musicList=t.list;for(var i=0;i<musicList.length;i++)musicList[i].original_type=0==musicList[i].is_campus?"0":"1";return count=t.count,renderMusicList(),t})}function getListHtmlStr(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!0;i&&(t=_xss.default(t));var e=ListTmplRender({list:t});return e}function renderMusicList(){var t=[];t="music"===tabState?musicList:addedList;var i=getListHtmlStr(t);$container.html(i||NoData)}function requestMusicList(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;return new Promise(function(e,n){$.ajax({url:"/aweme/v1/musician/songs/list/?offset=".concat(t,"&count=").concat(i),method:"GET",success:function(t){if(0==t.status_code){var i=[];t.songs.map(function(t){i.push(Object.assign(t,{cover_url:t.cover_origin.url_list[1],song_url:t.download_url.url_list[1]}))}),e({list:i,count:parseInt(t.music_count)})}else n(t)},error:function(t){n(t)}})})}function verifyMusic(t){return addedList.every(function(i){return i.title!==t.title})}function addMusic(t){var i=getListHtmlStr(t);addedList.length<=0?(addedList=t,$container.html(i)):(addedList=addedList.concat(t),$container.append(i))}function getMusic(t){return addedList[t]||{}}function setMusic(t,i){var e=getListHtmlStr([i]);addedList[t]=i;var n=$container[0].children[t];$(n).replaceWith(e)}function getTabState(){return tabState}function changeTabState(t){t!==tabState&&(tabState=t,renderMusicList(),isFunc(onTabStateChange)&&onTabStateChange(tabState))}function listenStateChange(t){isFunc(t)&&(onTabStateChange=t)}function uploadMusicInfo(t){return t=t||addedList,new Promise(function(i,e){$.ajax({url:"/aweme/v1/musician/songs/",data:JSON.stringify(t),method:"POST",dataType:"json",contentType:"application/json; charset=utf-8",success:function(t){0==t.status_code?i(t):e(t)}})})}function flip(t){if(t){if(!canFlip().pre)return;page--}else{if(!canFlip().nxt)return;page++}requestMusicList(page*limit,limit).then(function(t){musicList=t.list,count=t.count,renderMusicList()})}function canFlip(){var t={pre:!0,nxt:!0};return 0===page&&(t.pre=!1),(page+1)*limit>=count&&(t.nxt=!1),t}var ListTmplRender=function(obj){{var __t,__p="";Array.prototype.join}with(obj||{}){__p+="";for(var i=0;i<list.length;i++)__p+='\n    <div class="submit-music-content">\n        <div class="submit-music-cover">\n            <img src="'+(null==(__t=list[i].cover_url)?"":__t)+'" alt="封面">\n        </div>\n        <div class="submit-music-name">\n            '+(null==(__t=list[i].title)?"":__t)+'\n        </div>\n        <div class="submit-music-audio">\n            <audio src="'+(null==(__t=list[i].song_url)?"":__t)+'" controls="controls">\n                Your browser does not support the audio element.\n            </audio>\n        </div>\n        <div class="submit-music-campus">\n            '+(null==(__t="1"==list[i].original_type?"是":"否")?"":__t)+"\n        </div>\n            ",list[i].edit&&(__p+='\n                <button class="submit-music-edit">修改</button>\n            '),__p+='\n            <div class="submit-music-status submit-music-status-'+(null==(__t=list[i].status||0)?"":__t)+'">\n                ',0==list[i].status&&(__p+="\n                    "+(null==(__t="审核中...")?"":__t)+"\n                "),__p+="\n                ",1==list[i].status&&(__p+="\n                    "+(null==(__t="审核成功")?"":__t)+"\n                "),__p+="\n                ",2==list[i].status&&(__p+="\n                    "+(null==(__t="未通过")?"":__t)+"\n                "),__p+="\n            </div>\n    </div>\n";__p+=""}return __p},NoData="暂无作品，点击添加音乐添加你的作品～",tabState="music",musicList=[],addedList=[],page=0,limit=10,count=0,$container=null,onTabStateChange=null;return{init:init,addMusic:addMusic,getMusic:getMusic,setMusic:setMusic,verifyMusic:verifyMusic,uploadMusicInfo:uploadMusicInfo,flip:flip,canFlip:canFlip,changeTabState:changeTabState,getTabState:getTabState,listenStateChange:listenStateChange}}(),modalCtrl=function(){var t=$("#modal"),i=$("#modalContainer"),e=$("#uploadMusicForm"),n=void 0;return{getId:function(){return n},initForm:function(t){for(var i in t)"original_type"===i?"1"==t[i]?($("input[type='radio'][name='original_type'][value='1']").prop("checked","checked"),$("#lyric-upload").find(".submit-modal-label").addClass("label-not-null"),$("#music-upload").show()):($("input[type='radio'][name='original_type'][value='0']").prop("checked","checked"),$("#lyric-upload").find(".submit-modal-label").removeClass("label-not-null"),$("#music-upload").hide()):("style"===i&&t.sel&&t.sel.select(t[i]),$(e[0][i]).val(t[i]))},show:function(e){n=e,t.addClass("submit-modal-show"),setTimeout(function(){i.addClass("submit-modal-container-show")},100)},hide:function(){e[0].reset(),t.removeClass("submit-modal-show"),i.removeClass("submit-modal-container-show")}}}();$.ajax({url:"/aweme/v1/musician/verify/status/",method:"GET",success:function(t){0==t.status_code&&(1==t.status?$("#verifyStatus").html("(审核中)").show():2==t.status?$("#verifyStatus").html("(审核通过)").show():location.assign("/apply_verify/"))}}),musicCtrl.init("#musicListCont").then(function(t){verifyFlip(),t.list.length>0&&($("#showModalBtn").html("+ 继续添加音乐"),$("#submitApply").hide())}),musicCtrl.listenStateChange(function(t){var i={disabled:!0,style:"color: #ccc"},e={disabled:!1,style:"color: #4a4a4a"};"music"===t?(verifyFlip(),$("#showMusic").attr(i),$("#showAdded").attr(e)):($("#pagePre").attr(i),$("#pageNxt").attr(i),$("#showMusic").attr(e),$("#showAdded").attr(i))}),$("#showMusic").click(function(){musicCtrl.changeTabState("music")}),$("#showAdded").click(function(){musicCtrl.changeTabState("added")}),$("#submitApply").click(function(){musicCtrl.uploadMusicInfo().then(function(){location.assign("/apply_success/")}).catch(function(){_toast.default.show({title:"提交失败",content:"服务器出了个小差，请重新试试～"})})}),$("#pagePre").click(function(){musicCtrl.flip(!0),verifyFlip()}),$("#pageNxt").click(function(){musicCtrl.flip(),verifyFlip()}),$("#showModalBtn").click(function(){modalCtrl.show()}),$("#hideModalBtn").click(function(){modalCtrl.hide()}),$("#coverFile").change(function(t){var i="/aweme/v1/musician/upload/image/",e="#coverName",n="#cover_uri",a=t.target.files[0];if(a){var r=new _file.default(a),u=r.getFileInfo();r.getUrlData().then(function(t){return Promise.all([t,r.getImageSize(t)])}).then(function(t){return r.comporessImage({urlData:t[0],imageInfo:t[1],compressSize:2e3})}).then(function(){r.upload({url:i,progress:progress(e),success:function(t){0==t.status_code?($(e).val(u.fileName),$(n).val(t.data.uri).change()):$(e).val("上传失败")},error:function(){$(e).val("上传失败")}})})}}),$("#musicFile").change(function(t){var i="/aweme/v1/musician/upload/music/",e="#musicName",n="#song_uri",a=t.target.files[0];if(a){var r=new _file.default(a),u=r.getFileInfo();r.upload({url:i,data:{file_type:u.type},progress:progress(e),success:function(t){0==t.status_code?r.getAudioDuration().then(function(i){if(i){var a=JSON.stringify({duration:i,uri:t.data.uri});$(e).val(u.fileName),$(n).val(a).change()}else Promise.reject("文件解析失败")}).catch(function(){$(e).val("上传失败")}):$(e).val("上传失败")},error:function(){$(e).val("上传失败")}})}}),$("#lyricFile").change(function(t){var i="/aweme/v1/musician/upload/image/",e="#lyricName",n="#lyric",a=t.target.files[0],r={};if(a){var u=new _file.default(a),s=u.getFileInfo();u.getTextData().then(function(){r.type=getLyricType(u.getFileInfo().type),u.upload({url:i,progress:progress(e),success:function(t){0==t.status_code?($(e).val(s.fileName),r.lyric=t.data.uri,r=JSON.stringify(r),$(n).val(r).change()):$(e).val("上传失败")},error:function(){$(e).val("上传失败")}})}).catch(function(){$(e).val("歌词解析失败")})}}),$("#qupuFile").change(function(t){var i="/aweme/v1/musician/upload/image/",e="#qupuName",n="#qupu_uri",a=t.target.files[0];if(a){var r=new _file.default(a),u=r.getFileInfo();r.upload({url:i,progress:progress(e),success:function(t){0==t.status_code?($(e).val(u.fileName),$(n).val(t.data.uri).change()):$(e).val("上传失败")},error:function(){$(e).val("上传失败")}})}}),$("input[type=radio][name=original_type]").change(function(){"1"==this.value?($("#lyric-upload").find(".submit-modal-label").addClass("label-not-null"),$("#music-upload").show()):"0"==this.value&&($("#lyric-upload").find(".submit-modal-label").removeClass("label-not-null"),$("#music-upload").hide())}),$("#musicListCont").on("click",".submit-music-edit",function(t){var i=Array.prototype.slice.call($("#musicListCont")[0].children,0),e=i.indexOf(t.target.parentNode),n=musicCtrl.getMusic(e);try{n=JSON.stringify(n),n=JSON.parse(n)}catch(a){return void _toast.default.show({title:"JSON解析失败",content:"JSON解析失败，请提交后刷新后再试"})}n.coverName=n.cover_uri,n.musicName=n.song_uri,n.lyricName=n.lyric_uri,n.original_type=n.original_type,n.qupuName=n.qupu_uri,n.song_uri=JSON.stringify({uri:n.song_uri,duration:n.duration}),n.lyric=JSON.stringify({lyric:n.lyric_uri,type:n.type}),modalCtrl.initForm(n),modalCtrl.show(e)});var $form=$("#uploadMusicForm"),form=(new _dropkick.default("#stepSelect"),new _form.default($form[0]));$form.change(function(){var t=$("input[name='original_type']:checked").val(),i=["title","cover_uri","song_uri"];"1"==t&&(i.push("qupu_uri"),i.push("lyric"));var i=form.verifyFrom(i);$("#submitBtn").attr(i.length<1?{disabled:!1,"class":"step-button"}:{disabled:!0,"class":"step-button-disable"})}),$form.validate({debug:!0,submitHandler:function(){var t=form.getObjData(["title","cover_uri","song_uri","lyric","style","qupu_uri"]),i={},e={},n=$("input[name='original_type']:checked").val();try{i=JSON.parse(t.song_uri),t.style=JSON.parse(t.style)}catch(a){return i={},console.warn(a),void _toast.default.show({title:"添加歌曲失败",content:"歌曲添加失败，请重新上传"})}try{e=t.lyric&&JSON.parse(t.lyric)||{}}catch(a){return e={},void _toast.default.show({title:"歌词文件错误",content:"歌词文件解析错误"})}var r={};r="1"==n?{edit:!0,song_uri:i.uri,lyric_uri:e.lyric,cover_uri:t.cover_uri,qupu_uri:t.qupu_uri,title:t.title,duration:i.duration,original_type:n,lyric_type:e.type||0,cover_url:"http://p3.pstatp.com/obj/".concat(t.cover_uri),song_url:"http://p3.pstatp.com/obj/".concat(i.uri),song_sheet:"http://p3.pstatp.com/obj/".concat(t.qupu_uri)}:{edit:!0,song_uri:i.uri,cover_uri:t.cover_uri,title:t.title,duration:i.duration,original_type:0,lyric_type:e.type||0,lyric_uri:e.lyric,cover_url:"http://p3.pstatp.com/obj/".concat(t.cover_uri),song_url:"http://p3.pstatp.com/obj/".concat(i.uri)};var u=modalCtrl.getId();if(void 0!==u)musicCtrl.setMusic(u,r);else{if(!musicCtrl.verifyMusic(r))return void _toast.default.show({title:"添加歌曲失败",content:"歌曲与以提交列表歌曲同名，换首歌试试吧～"});musicCtrl.addMusic([r])}modalCtrl.hide(),musicCtrl.changeTabState("added"),$("#submitApply").show()},rules:{title:{required:!0},cover_uri:{required:!0},song_uri:{required:!0}},messages:{title:"歌曲名不能为空",cover_uri:"请上传歌曲封面",song_uri:"请上传音乐文件"}})})});